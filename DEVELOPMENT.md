# create-nfdd Development Guide

This document explains how to maintain and update the `create-nfdd` package.

## Architecture

`create-nfdd` uses a **two-repository strategy**:

1. **mono-repo-starter** (`../mono-repo-starter/`) - The working, testable codebase
2. **create-nfdd** (this directory) - The npm package generator

This allows you to:
- Actively develop and test features in `mono-repo-starter`
- Keep the template up-to-date by syncing changes
- Avoid Handlebars escaping issues in TypeScript files

## Workflow

### 1. Update the Base Template

Make changes in the `mono-repo-starter` directory:

```bash
cd ../mono-repo-starter
# Make your changes, test them, commit them
docker compose -f docker-compose.dev.yml up -d
# Test your changes...
git add .
git commit -m "Add new feature"
```

### 2. Sync Template to create-nfdd

Run the sync script to copy changes and apply template substitutions:

```bash
cd ../create-nfdd
pnpm sync
```

This will:
- Copy all files from `mono-repo-starter` (excluding `node_modules`, `.git`, etc.)
- Apply Handlebars variable substitutions to:
  - `package.json` - `{{name}}`, `{{description}}`, `{{author}}`, `{{email}}`, `{{license}}`
  - `.env.dev` & `.env.prod` - `{{database}}`, `{{apiPort}}`, `{{webPort}}`
  - `apps/web-client/.env.local` - `{{apiPort}}`
- Rebuild the TypeScript CLI

### 3. Test Locally

Test the generator locally:

```bash
# Create a test project
cd /tmp
node /path/to/create-nfdd/lib/cli.js my-test-app

# Or use the test script
cd /path/to/create-nfdd
pnpm test
```

### 4. Publish to npm

Once tested:

```bash
# Bump version
npm version patch  # or minor, or major

# Publish (runs prepublishOnly hook automatically)
npm publish
```

The `prepublishOnly` hook will automatically run `pnpm sync` before publishing.

## Template Variables

The sync script automatically substitutes these variables:

### User Prompts (from create-create-app)
- `{{name}}` - Project name
- `{{description}}` - Project description
- `{{author}}` - Author name
- `{{email}}` - Author email (optional)
- `{{license}}` - License type (MIT, ISC, etc.)

### Custom Prompts (defined in src/cli.ts)
- `{{database}}` - Database name (default: `app_db`)
- `{{apiPort}}` - Backend API port (default: `3001`)
- `{{webPort}}` - Frontend port (default: `3000`)

## File Structure

```
create-nfdd/
├── src/
│   └── cli.ts           # CLI configuration
├── lib/                 # Compiled TypeScript (gitignored)
├── templates/
│   └── default/         # Template files (generated by sync-template.sh)
├── sync-template.sh     # Sync script
├── package.json
├── tsconfig.json
├── README.md            # User documentation
└── DEVELOPMENT.md       # This file
```

## Modifying Template Variables

### Adding a New Variable

1. **Update `src/cli.ts`** - Add to `extra` configuration:
```typescript
extra: {
  myNewVar: {
    type: 'input',
    describe: 'My new variable description',
    default: 'default-value',
    prompt: 'if-no-arg',
  },
}
```

2. **Update `sync-template.sh`** - Add substitution:
```bash
sed -i '' 's/OLD_VALUE/{{myNewVar}}/' "$TEMPLATE_DIR/path/to/file"
```

3. **Rebuild and test**:
```bash
pnpm sync
pnpm test
```

### Modifying Existing Variables

Simply update the `sed` commands in `sync-template.sh` to target different files or patterns.

## Troubleshooting

### Template not updating after mono-repo changes

Run `pnpm sync` manually to regenerate the template.

### Handlebars parse errors

If you add new files with `{{` syntax (React JSX, TypeScript decorators, etc.), they don't need escaping because we copy the entire template as-is. Handlebars only processes the specific variables we substitute via `sed`.

### Testing specific scenarios

Create custom test cases:

```bash
node lib/cli.js test-app \
  --name=my-custom-test \
  --database=custom_db \
  --apiPort=5000 \
  --webPort=8080
```

## Publishing Checklist

Before publishing:

- [ ] Test in `mono-repo-starter` (run docker compose, verify all features work)
- [ ] Run `pnpm sync` to update template
- [ ] Test `create-nfdd` locally with a new project
- [ ] Verify generated project runs: `docker compose -f docker-compose.dev.yml up -d`
- [ ] Check all template variables are substituted correctly
- [ ] Update version in `package.json`
- [ ] Update `README.md` if user-facing changes
- [ ] Commit changes to both repos (mono-repo-starter and create-nfdd)
- [ ] Run `npm publish`

## Maintenance

### Regular Updates

Keep dependencies updated:

```bash
# In mono-repo-starter
cd ../mono-repo-starter
pnpm update

# Test everything still works
docker compose -f docker-compose.dev.yml up -d --build

# Sync to create-nfdd
cd ../create-nfdd
pnpm sync
```

### Sync Frequency

Sync the template whenever you:
- Add new features to mono-repo-starter
- Update dependencies
- Fix bugs
- Change configuration
- Update documentation

## Version Strategy

- **Patch (1.0.x)** - Bug fixes, documentation updates
- **Minor (1.x.0)** - New features, non-breaking changes
- **Major (x.0.0)** - Breaking changes (e.g., major version bumps of core dependencies)

## Support

For issues or questions:
1. Check if the issue is in `mono-repo-starter` (base template) or `create-nfdd` (generator)
2. Test both independently
3. Open an issue in the relevant repository
